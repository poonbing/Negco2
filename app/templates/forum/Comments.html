<!DOCTYPE html>
<html>
<head>
  <title>Post</title>
  <meta name="csrf-token" content="{{ form.csrf_token }}">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-100">
  {% block navbar %} {% include 'forum/CommentCreation.html' %}  {% endblock %}
  <div class="container mx-auto mt-8">
    <div class="post">
      <h1 class="text-2xl font-bold mb-4">{{ post.title }}</h1>
      <div class="post-content">
        {{ post.content | safe }}
      </div>
    </div>

    <div class="comments mt-8 space-y-4">
      {% for comment in comment_list %}
        <div class="bg-white p-4 rounded-lg shadow-md">
          {% if current_user.id == comment.commenter %}
            <!-- Edit button for the comment -->
            <button class="text-blue-500 hover:underline mr-2" onclick="openEditForm({{ comment.id }})">Edit</button>
            <button class="delete-comment-btn" onclick="confirmDelete({{ comment.id }})">Delete</button>
          {% endif %}
          <div class="comment-content text-gray-700 mb-2" id="comment-content-{{ comment.id }}">
            {{ comment.content | safe }}
          </div>
          {% if comment.image %}
            <img src="{{ url_for('static', filename='images/' + comment.image) }}" alt="Uploaded Image" class="max-w-xs mb-2">
          {% endif %}
          <div class="comment-details text-gray-500">
            Posted by {{ comment.commenter }}
          </div>
        </div>

        <!-- Edit form for the comment -->
        <form class="edit-form hidden mt-4" id="edit-form-{{ comment.id }}" action="{{ url_for('forum.edit_comment', comment_id=comment.id) }}" method="POST" enctype="multipart/form-data">
          {{ form.csrf_token }}
          <label for="content-{{ comment.id }}" class="block font-medium mb-1">Edit Content:</label>
          <textarea id="content-{{ comment.id }}" name="content" class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 mb-2">{{ comment.content }}</textarea>
          <input type="file" name="image" accept="image/*" class="mb-2">
          <button type="submit" class="bg-blue-500 text-white py-1 px-3 rounded-md mr-2">Save</button>
          <button type="button" onclick="closeEditForm({{ comment.id }})" class="bg-gray-300 text-gray-700 py-1 px-3 rounded-md">Cancel</button>
        </form>
      {% endfor %}
    </div>
  </div>

</body>
</html>
<script>
  // Function to open the edit form
  function openEditForm(commentId) {
    const form = document.getElementById(`edit-form-${commentId}`);
    form.classList.remove("hidden");

    // Fill the edit form with the current comment content
    const contentElem = document.getElementById(`comment-content-${commentId}`);
    const commentContent = contentElem.innerHTML;
    const commentImage = contentElem.nextElementSibling?.getAttribute("src");

    form.querySelector(`textarea[name="content"]`).value = commentContent;
    form.querySelector(`input[name="image"]`).value = commentImage;
  }

  // Function to close the edit form
  function closeEditForm(commentId) {
    const form = document.getElementById(`edit-form-${commentId}`);
    form.classList.add("hidden");
  }

  // Function to submit the edit form
  function submitEditForm(event, commentId) {
    event.preventDefault();

    const form = document.getElementById(`edit-form-${commentId}`);
    const formData = new FormData(form);

    // You can optionally perform client-side validation here before submission

    // Submit the form using the standard HTML form submission
    form.submit();
  }
    function confirmDelete(commentId) {
      const confirmed = confirm("Are you sure you want to delete this comment?");
      if (confirmed) {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        fetch(`/delete_comment/${commentId}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken,
          },
        })
        .then(response => {
          if (response.status === 204) {  // 204 No Content is commonly used for successful DELETE requests
            window.location.reload();
          } else {
            console.error("Error deleting comment");
          }
        })
        .catch(error => {
          console.error("An error occurred:", error);
        });
      }
    }
</script>
