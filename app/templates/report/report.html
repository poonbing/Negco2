<!DOCTYPE html>
<html>
  <head>
    <title>Tracker Web App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
  </head>
  <body>
    {% include 'navbar.html' %}
<script>
    function createChart() {
        const height = 500;
        const marginTop = 100;
        const marginRight = 0;
        const marginBottom = 10;
        const marginLeft = 0;
        const barWidth = 20;  // The desired width of the bars in pixels
        const barPadding = 2;  // The desired space between the bars in pixels
        const totalWidth = (barWidth + barPadding) * m;
        const width = totalWidth + marginLeft + marginRight;
        const y01z = d3.stack().keys(d3.range(n))(d3.transpose(yz)).map((data, i) => data.map(([y0, y1]) => [y0, y1, i]));
        const yMax = d3.max(yz, y => d3.max(y));
        const y1Max = d3.max(y01z, y => d3.max(y, d => d[1]));
        const x = d3.scaleBand().domain(xz).range([marginLeft, marginLeft + totalWidth]).paddingInner(barPadding / (barWidth + barPadding));
        const y = d3.scaleLinear().domain([0, y1Max]).range([height - marginBottom, marginTop]);
        const color = d3.scaleSequential(d3.interpolateBlues).domain([-0.5 * n, 1.5 * n]);
        const svg = d3.create("svg").attr("viewBox", [0, 0, width, height]).attr("width", width).attr("height", height).attr("style", "max-width: 100%; height: auto;");
        const rect = svg.selectAll("g").data(y01z).join("g").attr("fill", (d, i) => color(i)).selectAll("rect").data(d => d).join("rect").attr("x", (d, i) => x(i)).attr("y", height - marginBottom).attr("width", x.bandwidth()).attr("height", 0);
        svg.append("g").attr("transform", `translate(0,${height - marginBottom})`).call(d3.axisBottom(x).tickSizeOuter(0).tickFormat(() => ""));
        d3.select('body').append(() => svg.node());

    function transitionGrouped() {
        y.domain([0, yMax]);
        rect.transition().duration(500).delay((d, i) => i * 20).attr("x", (d, i) => x(i) + x.bandwidth() / n * d[2]).attr("width", x.bandwidth() / n).transition().attr("y", d => y(d[1] - d[0])).attr("height", d => y(0) - y(d[1] - d[0]));
    }

    function transitionStacked() {
        y.domain([0, y1Max]);
        rect.transition().duration(500).delay((d, i) => i * 20).attr("y", d => y(d[1])).attr("height", d => y(d[0]) - y(d[1])).transition().attr("x", (d, i) => x(i)).attr("width", x.bandwidth());
    }

    function update(layout) {
    if (layout === "stacked") transitionStacked();
    else transitionGrouped();
    }

    return Object.assign(svg.node(), {update});
    }
    // Parameters
    let n = {{ n }};
    let m = {{ num_days }};

    // Function to generate bumps
    function bumps(m) {
        const values = [];
        for (let i = 0; i < m; ++i) {
            values[i] = 0.1 + 0.1 * Math.random();
        }
        for (let j = 0; j < 5; ++j) {
            const x = 1 / (0.1 + Math.random());
            const y = 2 * Math.random() - 0.5;
            const z = 10 / (0.1 + Math.random());
            for (let i = 0; i < m; i++) {
                const w = (i / m - y) * z;
                values[i] += x * Math.exp(-w * w);
            }
        }
        for (let i = 0; i < m; ++i) {
            values[i] = Math.max(0, values[i]);
        }
        return values;
    }

    function divideAndUpdateValues(inputArray, divisor) {
        if (divisor === 0) {
            throw new Error("Divisor cannot be zero");
        }

        let yz_array = Array({{ n }}).fill().map(() => Array({{ num_days }}).fill(0));

        for (let i = 0; i < inputArray.length; i++) {
            const item = inputArray[i];

            for (let j = 0; j < item.length; j++) {
                const dividedValue = item[j] / (divisor/{{ num_days }});
                console.log(dividedValue)
                yz_array[i][j] = dividedValue;
                console.log(yz_array)
            }
        }

        return yz_array;
    }

const resultArray = divideAndUpdateValues({{ datapoints }}, {{ target }});

    // Data
    let xz = d3.range(m);
    let yz = resultArray;
    console.log(xz)
    console.log(yz)
    console.log({{ datapoints }})

    // Layout
    let layout = "stacked";  // or "grouped"

    // Chart
    let chart = createChart();
    // Update
    let update = chart.update(layout);
</script>
<div>
    <input type="radio" id="grouped" name="layout" value="grouped">
    <label for="grouped">Grouped</label><br>
    <input type="radio" id="stacked" name="layout" value="stacked" checked>
    <label for="stacked">Stacked</label>
</div>
<script>
    // Function to change layout mode
    function changeLayoutMode(newLayout) {
        layout = newLayout;
        chart.update(layout);
    }

    // Event listener for radio button changes
    document.querySelectorAll('input[name="layout"]').forEach((elem) => {
        elem.addEventListener('change', (event) => {
            changeLayoutMode(event.target.value);
        });
    });
</script>
<div>
    {% for tracker in trackers %}
        <div style="border:2px; width: 50px;"></div>
        <br>
    {% endfor %}
</div>
{% include 'footer.html' %}
  </body>
</html>